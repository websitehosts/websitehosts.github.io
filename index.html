<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF 在线阅读器</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }
    .header {
      background-color: #333;
      color: white;
      padding: 10px 20px;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .theme-toggle {
      cursor: pointer;
      padding: 5px 10px;
      background-color: #555;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
    }
    #canvas-container {
      overflow: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-top: 20px;
      background-color: white;
      max-height: 80vh;
    }
    #pdf-canvas {
      display: block;
    }
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      padding: 10px;
      background-color: #eee;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #page-info {
      margin: 0 10px;
    }
    select, input {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .progress-bar {
      width: 100%;
      height: 5px;
      background-color: #eee;
      margin-top: 10px;
      border-radius: 5px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background-color: #4CAF50;
      width: 0%;
      transition: width 0.3s ease;
    }
    .bookmark-list {
      margin-top: 20px;
      width: 100%;
      max-width: 800px;
    }
    .bookmark-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      margin-bottom: 5px;
      background-color: #f0f0f0;
      border-radius: 4px;
    }
    .bookmark-item button {
      padding: 4px 8px;
      margin-left: 5px;
    }
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      display: none;
      z-index: 1000;
    }
    .dark-mode {
      background-color: #222;
      color: #eee;
    }
    .dark-mode .header {
      background-color: #111;
    }
    .dark-mode .controls {
      background-color: #333;
      color: #eee;
    }
    .dark-mode #canvas-container {
      background-color: #333;
      box-shadow: 0 4px 8px rgba(255,255,255,0.1);
    }
    .dark-mode select, .dark-mode input {
      background-color: #444;
      color: #eee;
      border-color: #555;
    }
    .dark-mode .bookmark-item {
      background-color: #444;
      color: #eee;
    }
    .search-container {
      display: flex;
      gap: 5px;
    }
    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      .search-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>PDF 在线阅读器</h1>
    <span class="theme-toggle" id="theme-toggle">切换深色模式</span>
  </div>
  <div class="container">
    <div class="controls">
      <div>
        <button id="prev" disabled>上一页</button>
        <span id="page-info">第 <span id="page-num">1</span> 页 / 共 <span id="page-count">?</span> 页</span>
        <button id="next" disabled>下一页</button>
      </div>
      <div>
        <select id="zoom">
          <option value="0.5">50%</option>
          <option value="0.75">75%</option>
          <option value="1" selected>100%</option>
          <option value="1.25">125%</option>
          <option value="1.5">150%</option>
          <option value="2">200%</option>
        </select>
        <button id="rotate">旋转</button>
        <input type="number" id="page-input" placeholder="跳转到页码" min="1">
        <button id="go-page">跳转</button>
      </div>
      <div class="search-container">
        <input type="text" id="search-text" placeholder="搜索文本">
        <button id="search-btn">搜索</button>
        <button id="prev-match" disabled>上一个结果</button>
        <button id="next-match" disabled>下一个结果</button>
      </div>
      <div>
        <button id="add-bookmark">添加书签</button>
        <button id="fullscreen">全屏</button>
      </div>
    </div>
    <div class="progress-bar">
      <div class="progress" id="progress"></div>
    </div>
    <div id="canvas-container">
      <canvas id="pdf-canvas"></canvas>
    </div>
    <div class="bookmark-list" id="bookmark-list">
      <h3>我的书签</h3>
      <div id="bookmarks-container"></div>
    </div>
  </div>
  <div class="notification" id="notification"></div>

  <script>
    // 配置 PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    // 替换为你的PDF文件路径，例如 "document.pdf"
    const pdfUrl = '冻融的十二月天空.pdf';
    
    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1;
    let rotation = 0;
    let canvas = document.getElementById('pdf-canvas');
    let ctx = canvas.getContext('2d');
    let currentPageText = null;
    let searchResults = [];
    let currentMatch = -1;
    let bookmarks = [];
    
    // 从Cookie中获取之前的阅读进度
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    // 设置Cookie
    function setCookie(name, value, days) {
      const d = new Date();
      d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
      const expires = `expires=${d.toUTCString()}`;
      document.cookie = `${name}=${value};${expires};path=/`;
    }
    
    // 显示通知
    function showNotification(message, duration = 3000) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, duration);
    }
    
    // 更新进度条
    function updateProgress() {
      const progress = document.getElementById('progress');
      const percentage = (pageNum / pdfDoc.numPages) * 100;
      progress.style.width = `${percentage}%`;
    }
    
    // 渲染页面
    function renderPage(num, keepPosition = false) {
      const previousScroll = keepPosition ? document.getElementById('canvas-container').scrollTop : 0;
      
      pdfDoc.getPage(num).then(function(page) {
        let viewport = page.getViewport({ scale: scale, rotation: rotation });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        let renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        
        const renderTask = page.render(renderContext);
        
        renderTask.promise.then(() => {
          document.getElementById('page-num').textContent = num;
          updateProgress();
          
          // 保存当前阅读进度到Cookie
          setCookie('pdfPageNum', num, 30);
          setCookie('pdfZoom', scale, 30);
          setCookie('pdfRotation', rotation, 30);
          
          if (keepPosition) {
            document.getElementById('canvas-container').scrollTop = previousScroll;
          }
          
          // 获取页面文本用于搜索功能
          return page.getTextContent();
        }).then(textContent => {
          currentPageText = textContent;
        });
      });
    }
    
    // 初始化
    function init() {
      pdfjsLib.getDocument(pdfUrl).promise.then(function(doc) {
        pdfDoc = doc;
        document.getElementById('page-count').textContent = doc.numPages;
        document.getElementById('page-input').max = doc.numPages;
        
        // 从Cookie中恢复阅读位置
        const savedPage = getCookie('pdfPageNum');
        const savedZoom = getCookie('pdfZoom');
        const savedRotation = getCookie('pdfRotation');
        
        if (savedPage && !isNaN(parseInt(savedPage)) && parseInt(savedPage) <= doc.numPages) {
          pageNum = parseInt(savedPage);
        }
        
        if (savedZoom && !isNaN(parseFloat(savedZoom))) {
          scale = parseFloat(savedZoom);
          document.getElementById('zoom').value = scale;
        }
        
        if (savedRotation && !isNaN(parseInt(savedRotation))) {
          rotation = parseInt(savedRotation);
        }
        
        renderPage(pageNum);
        
        // 加载保存的书签
        loadBookmarks();
        
        // 启用按钮
        document.getElementById('prev').disabled = false;
        document.getElementById('next').disabled = false;
      }).catch(error => {
        console.error('加载PDF出错:', error);
        showNotification('加载PDF出错: ' + error.message);
      });
    }
    
    // 搜索文本
    function searchText(text) {
      if (!currentPageText || !text.trim()) return;
      
      const textItems = currentPageText.items;
      const searchTerm = text.toLowerCase();
      searchResults = [];
      
      for (let i = 0; i < textItems.length; i++) {
        const item = textItems[i];
        if (item.str.toLowerCase().includes(searchTerm)) {
          searchResults.push(item);
        }
      }
      
      if (searchResults.length > 0) {
        currentMatch = 0;
        highlightMatch();
        document.getElementById('prev-match').disabled = false;
        document.getElementById('next-match').disabled = false;
        showNotification(`找到 ${searchResults.length} 个匹配结果`);
      } else {
        currentMatch = -1;
        document.getElementById('prev-match').disabled = true;
        document.getElementById('next-match').disabled = true;
        showNotification('未找到匹配结果');
      }
    }
    
    // 高亮搜索结果
    function highlightMatch() {
      if (currentMatch < 0 || currentMatch >= searchResults.length) return;
      
      const item = searchResults[currentMatch];
      
      // 在匹配位置绘制高亮框
      const scale = viewport.scale;
      const rotation = viewport.rotation;
      
      // 暂时简单实现，只是通知用户
      showNotification(`显示第 ${currentMatch + 1}/${searchResults.length} 个匹配结果`);
    }
    
    // 保存书签
    function saveBookmarks() {
      localStorage.setItem('pdfBookmarks', JSON.stringify(bookmarks));
      renderBookmarks();
    }
    
    // 加载书签
    function loadBookmarks() {
      const savedBookmarks = localStorage.getItem('pdfBookmarks');
      if (savedBookmarks) {
        try {
          bookmarks = JSON.parse(savedBookmarks);
          renderBookmarks();
        } catch (e) {
          console.error('加载书签出错:', e);
          bookmarks = [];
        }
      }
    }
    
    // 添加书签
    function addBookmark() {
      const bookmarkName = prompt('请输入书签名称:', `第 ${pageNum} 页`);
      if (bookmarkName) {
        const bookmark = {
          name: bookmarkName,
          page: pageNum,
          zoom: scale,
          rotation: rotation,
          timestamp: new Date().toISOString()
        };
        
        bookmarks.push(bookmark);
        saveBookmarks();
        showNotification('书签已添加');
      }
    }
    
    // 渲染书签列表
    function renderBookmarks() {
      const container = document.getElementById('bookmarks-container');
      container.innerHTML = '';
      
      if (bookmarks.length === 0) {
        container.innerHTML = '<p>还没有添加书签</p>';
        return;
      }
      
      bookmarks.forEach((bookmark, index) => {
        const item = document.createElement('div');
        item.className = 'bookmark-item';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = `${bookmark.name} (第 ${bookmark.page} 页)`;
        
        const buttonContainer = document.createElement('div');
        
        const gotoButton = document.createElement('button');
        gotoButton.textContent = '跳转';
        gotoButton.addEventListener('click', () => {
          pageNum = bookmark.page;
          scale = bookmark.zoom;
          rotation = bookmark.rotation;
          document.getElementById('zoom').value = scale;
          renderPage(pageNum);
        });
        
        const deleteButton = document.createElement('button');
        deleteButton.textContent = '删除';
        deleteButton.addEventListener('click', () => {
          bookmarks.splice(index, 1);
          saveBookmarks();
          showNotification('书签已删除');
        });
        
        buttonContainer.appendChild(gotoButton);
        buttonContainer.appendChild(deleteButton);
        
        item.appendChild(nameSpan);
        item.appendChild(buttonContainer);
        container.appendChild(item);
      });
    }
    
    // 切换深色/浅色模式
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      document.getElementById('theme-toggle').textContent = isDark ? '切换浅色模式' : '切换深色模式';
      localStorage.setItem('darkMode', isDark ? 'true' : 'false');
    }
    
    // 全屏模式
    function toggleFullscreen() {
      const container = document.getElementById('canvas-container');
      
      if (!document.fullscreenElement) {
        if (container.requestFullscreen) {
          container.requestFullscreen();
        } else if (container.mozRequestFullScreen) {
          container.mozRequestFullScreen();
        } else if (container.webkitRequestFullscreen) {
          container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
          container.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    }
    
    // 事件监听器
    document.getElementById('prev').addEventListener('click', function() {
      if (pageNum <= 1) return;
      pageNum--;
      renderPage(pageNum);
    });
    
    document.getElementById('next').addEventListener('click', function() {
      if (pageNum >= pdfDoc.numPages) return;
      pageNum++;
      renderPage(pageNum);
    });
    
    document.getElementById('zoom').addEventListener('change', function() {
      scale = parseFloat(this.value);
      renderPage(pageNum, true);
    });
    
    document.getElementById('rotate').addEventListener('click', function() {
      rotation = (rotation + 90) % 360;
      renderPage(pageNum);
    });
    
    document.getElementById('go-page').addEventListener('click', function() {
      const input = document.getElementById('page-input');
      const page = parseInt(input.value);
      
      if (isNaN(page) || page < 1 || page > pdfDoc.numPages) {
        showNotification(`请输入1至${pdfDoc.numPages}之间的页码`);
        return;
      }
      
      pageNum = page;
      renderPage(pageNum);
    });
    
    document.getElementById('search-btn').addEventListener('click', function() {
      const text = document.getElementById('search-text').value;
      searchText(text);
    });
    
    document.getElementById('search-text').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const text = document.getElementById('search-text').value;
        searchText(text);
      }
    });
    
    document.getElementById('prev-match').addEventListener('click', function() {
      if (searchResults.length === 0) return;
      
      currentMatch = (currentMatch - 1 + searchResults.length) % searchResults.length;
      highlightMatch();
    });
    
    document.getElementById('next-match').addEventListener('click', function() {
      if (searchResults.length === 0) return;
      
      currentMatch = (currentMatch + 1) % searchResults.length;
      highlightMatch();
    });
    
    document.getElementById('add-bookmark').addEventListener('click', addBookmark);
    
    document.getElementById('fullscreen').addEventListener('click', toggleFullscreen);
    
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    
    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
      if (e.target.tagName === 'INPUT') return; // 输入框中不触发快捷键
      
      switch(e.key) {
        case 'ArrowLeft':
          if (pageNum > 1) {
            pageNum--;
            renderPage(pageNum);
          }
          break;
        case 'ArrowRight':
          if (pageNum < pdfDoc.numPages) {
            pageNum++;
            renderPage(pageNum);
          }
          break;
        case '+':
          scale = Math.min(scale + 0.25, 3);
          document.getElementById('zoom').value = scale;
          renderPage(pageNum, true);
          break;
        case '-':
          scale = Math.max(scale - 0.25, 0.25);
          document.getElementById('zoom').value = scale;
          renderPage(pageNum, true);
          break;
        case 'r':
          rotation = (rotation + 90) % 360;
          renderPage(pageNum);
          break;
        case 'f':
          toggleFullscreen();
          break;
      }
    });
    
    // 恢复深色模式设置
    const savedTheme = localStorage.getItem('darkMode');
    if (savedTheme === 'true') {
      document.body.classList.add('dark-mode');
      document.getElementById('theme-toggle').textContent = '切换浅色模式';
    }
    
    // 初始化
    init();
  </script>
</body>
</html>
